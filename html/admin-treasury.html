<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Ratio Trading - Treasury Administration</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 20px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }
        
        .header-title {
            color: #333;
            font-size: 2.5em;
            font-weight: bold;
        }
        
        .header-center {
            text-align: center;
            flex-grow: 1;
        }
        
        .page-title {
            color: #333;
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 1.2em;
        }
        
        .navigation {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .admin-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #f59e0b;
        }
        
        .admin-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-section p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group .help-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .status-message.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .status-message.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        
        .status-message.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        /* Match admin-system status layout */
        .system-status {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
        }
        
        .status-item:last-child { margin-bottom: 0; }
        
        .status-label {
            font-weight: 500;
            color: #555;
        }
        
        .treasury-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }
        
        .treasury-info h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        
        .info-label {
            font-weight: 500;
            color: #555;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-weight: 600;
            color: #333;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .status-value {
            font-weight: 600;
            color: #333;
        }
        
        .status-value.online {
            color: #10b981;
        }
        
        .status-value.offline {
            color: #ef4444;
        }
        
        .countdown-display {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
        }
        
        .footer {
            margin-top: 30px;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            color: #666;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <img src="images/Fixedratio_1024x1024.png" alt="Fixed Ratio Trading Logo" class="logo">
                <div class="header-title">Fixed Ratio Trading</div>
            </div>
            <div class="header-center">
                <h1 class="page-title">Treasury Administration</h1>
                <p class="subtitle">Treasury Operations & Fee Management</p>
            </div>
            <div class="navigation">
                <a href="admin.html" class="btn btn-secondary">
                    üîß Admin Dashboard
                </a>
                <a href="index.html" class="btn btn-secondary">
                    üè† Main Dashboard
                </a>
            </div>
        </div>
        
        <div id="status-container"></div>
        
        <!-- Treasury Information Section -->
        <div class="admin-section">
            <h3>üìä Treasury Information</h3>
            <p>Current treasury state and fee collection statistics.</p>
            
            <div id="treasury-info-content" class="system-status">
                <div class="status-item">
                    <span class="status-label">Total Balance</span>
                    <span class="status-value" id="treasury-total-balance">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Total Withdrawn</span>
                    <span class="status-value" id="treasury-total-withdrawn">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Total Operations*</span>
                    <span class="status-value" id="treasury-total-ops">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Last Withdrawal</span>
                    <span class="status-value" id="last-withdrawal">Never</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Next Withdrawal</span>
                    <span class="status-value" id="next-withdrawal-countdown">0m 0s</span>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="refreshTreasuryInfo()">
                üîÑ Refresh Treasury Info
            </button>
        </div>
        
        <!-- Fee Consolidation Section -->
        <div class="admin-section">
            <h3>üîÑ Fee Consolidation</h3>
            <p>Consolidate fees from individual pools to the main treasury.</p>
            
            <div class="form-group">
                <label for="pool-ids">Pool IDs (One per line)</label>
                <textarea id="pool-ids" rows="5" placeholder="Enter pool state PDA addresses, one per line"></textarea>
                <div class="help-text">Enter pool state PDA addresses to consolidate fees from specific pools</div>
            </div>
            
            <div class="form-row">
                <div>
                    <button id="consolidate-selected-btn" class="btn btn-warning" onclick="executeConsolidateSelectedPools()" style="width: 100%;">
                        üîÑ Consolidate Selected Pools
                    </button>
                    <div class="help-text">Consolidate fees from specified pools</div>
                </div>
                <div>
                    <button id="consolidate-all-btn" class="btn btn-success" onclick="executeConsolidateAllPools()" style="width: 100%;">
                        üîÑ Consolidate All Pools
                    </button>
                    <div class="help-text">Automatically discover and consolidate all pools</div>
                </div>
            </div>
        </div>
        
        <!-- Pool State Management Section -->
        <div class="admin-section">
            <h3>‚è∏Ô∏è Pool State Management</h3>
            <p>Manage pool pause states before and after consolidation operations.</p>
            
            <div class="form-group">
                <label for="consolidation-pools">Pools for State Management</label>
                <textarea id="consolidation-pools" rows="3" placeholder="Enter pool state PDA addresses for pause/unpause operations"></textarea>
                <div class="help-text">Enter pool addresses to manage their pause states</div>
            </div>
            
            <div class="form-row">
                <div>
                    <button id="pause-pools-btn" class="btn btn-warning" onclick="executePausePools()" style="width: 100%;">
                        ‚è∏Ô∏è Pause Pools
                    </button>
                    <div class="help-text">Pause specified pools before consolidation</div>
                </div>
                <div>
                    <button id="unpause-pools-btn" class="btn btn-success" onclick="executeUnpausePools()" style="width: 100%;">
                        ‚ñ∂Ô∏è Unpause Pools
                    </button>
                    <div class="help-text">Resume specified pools after consolidation</div>
                </div>
            </div>
        </div>
        
        <!-- Fee Withdrawal Section -->
        <div class="admin-section">
            <h3>üí∞ Fee Withdrawal</h3>
            <p>Withdraw collected fees from the treasury (subject to dynamic rate limiting).</p>
            
            <div class="form-group">
                <label for="withdrawal-amount">Withdrawal Amount (SOL)</label>
                <input type="number" id="withdrawal-amount" step="0.001" placeholder="Leave empty for maximum amount">
                <div class="help-text">Enter amount in SOL, or leave empty to withdraw maximum available amount. <span id="withdraw-max-info">Maximum available: -- SOL</span></div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 15px;">
                <button id="withdraw-fees-btn" class="btn btn-primary" onclick="executeTreasuryWithdrawFees()">
                    üí∞ Withdraw Fees
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p>Fixed Ratio Trading Treasury Administration | Local Solana Testnet</p>
            <p style="color: #6b7280; font-size: 12px; margin-top: 10px;">
                ‚ö†Ô∏è Treasury operations require admin authority and affect fee collection
            </p>
        </div>
    </div>

    <script src="libs/solana-web3.min.js"></script>
    <script src="config.js"></script>
    <script src="data-service.js"></script>
    <script src="utils.js"></script>
    <script src="admin-utils.js"></script>
    <script>
        // Global state
        let treasuryInfo = null;
        let discoveredPools = [];
        // Withdrawal rate limiting constants (mirror on-chain defaults)
        const RATE_LIMIT_WINDOW_SECS = 3600; // 60 minutes
        const BASE_HOURLY_RATE_LAMPORTS = 10_000_000_000; // 10 SOL
        const MAX_DRAIN_TIME_HOURS = 48;
        const RATE_SCALING_MULTIPLIER = 10;
        const MIN_WITHDRAW_LAMPORTS = 10_000_000; // 0.01 SOL
        
        // Initialize treasury admin page
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üí∞ Treasury Administration page initializing...');
            await initializeTreasuryAdmin();
        });
        
        /**
         * Initialize treasury administration page
         */
        async function initializeTreasuryAdmin() {
            try {
                // Initialize admin utilities
                await window.AdminUtils.initializeAdminUtils();
                
                // Check wallet connection
                const isConnected = sessionStorage.getItem('adminWalletConnected') === 'true';
                const walletProvider = sessionStorage.getItem('adminWalletProvider');
                if (!isConnected) {
                    showStatus('warning', '‚ö†Ô∏è Wallet not connected. Please connect your wallet first.');
                    return;
                }
                
                console.log(`‚úÖ Using ${walletProvider || 'Unknown'} wallet for treasury administration`);
                
                // Auto-refresh treasury info if wallet is connected
                await refreshTreasuryInfo();
                // Start withdrawal countdown watcher
                startWithdrawalCountdownWatcher();
                
                console.log('‚úÖ Treasury administration page initialized');
            } catch (error) {
                console.error('‚ùå Failed to initialize treasury admin:', error);
                showStatus('error', 'Failed to initialize treasury administration: ' + error.message);
            }
        }
        
        /**
         * Refresh treasury information
         */
        async function refreshTreasuryInfo() {
            try {
                showStatus('info', 'üîÑ Refreshing treasury information...');
                // Load real-time treasury info via centralized data service
                if (!window.TradingDataService?.connection) {
                    // Ensure a connection exists if admin utils connection is not ready
                    const conn = window.AdminUtils?.adminConnection || new solanaWeb3.Connection(window.CONFIG.rpcUrl, { commitment: 'confirmed' });
                    await window.TradingDataService.initialize(window.CONFIG, conn);
                }
                const state = await window.TradingDataService.loadStateJsonExact();
                const t = state.main_treasury_state;
                if (!t) throw new Error('Treasury state not found');

                const totalBalanceSol = (t.total_balance / 1_000_000_000).toFixed(9).replace(/0+$/,'').replace(/\.$/,'');
                const totalWithdrawnSol = (t.total_withdrawn / 1_000_000_000).toFixed(9).replace(/0+$/,'').replace(/\.$/,'');
                const lastUpdate = t.last_update_timestamp ? new Date(t.last_update_timestamp * 1000).toLocaleString() : 'N/A';
                const lastWithdrawTs = (t.last_withdrawal_timestamp ?? 0);

                // Compute maximum withdrawable using live account info and rent exemption
                let maxLamports = 0;
                try {
                    const conn = window.TradingDataService.connection;
                    const treasuryAddr = state.pda_addresses?.main_treasury;
                    if (treasuryAddr) {
                        const pk = new solanaWeb3.PublicKey(treasuryAddr);
                        const acct = await conn.getAccountInfo(pk, { commitment: 'confirmed' });
                        if (acct) {
                            const rentMinComputed = await conn.getMinimumBalanceForRentExemption(acct.data.length);
                            const availableAfterRent = Math.max(0, acct.lamports - rentMinComputed);
                            // Apply dynamic hourly rate limit (cap withdrawals to current hourly limit)
                            const hourlyCap = calculateCurrentHourlyRateLimit(availableAfterRent);
                            maxLamports = Math.min(availableAfterRent, hourlyCap);
                        }
                    }
                    // Fallback to state fields if account lookup failed
                    if (maxLamports === 0) {
                        const rentMin = (t.rent_exempt_minimum || 0);
                        const availableAfterRent = Math.max(0, (t.total_balance || 0) - rentMin);
                        const hourlyCap = calculateCurrentHourlyRateLimit(availableAfterRent);
                        maxLamports = Math.min(availableAfterRent, hourlyCap);
                    }
                } catch (_) {
                    const rentMin = (t.rent_exempt_minimum || 0);
                    const availableAfterRent = Math.max(0, (t.total_balance || 0) - rentMin);
                    const hourlyCap = calculateCurrentHourlyRateLimit(availableAfterRent);
                    maxLamports = Math.min(availableAfterRent, hourlyCap);
                }
                // Floor to 2 decimals in SOL, treat < 0.01 as 0.00
                let maxSol = maxLamports / 1_000_000_000;
                maxSol = Math.floor(maxSol * 100) / 100;
                if (maxSol < 0.01) maxSol = 0.00;

                treasuryInfo = {
                    totalBalance: totalBalanceSol,
                    totalWithdrawn: totalWithdrawnSol,
                    // Align with on-chain total_successful_operations (includes donations and consolidations)
                    totalOperations: (
                        (t.pool_creation_count || 0) +
                        (t.liquidity_operation_count || 0) +
                        (t.regular_swap_count || 0) +
                        (t.treasury_withdrawal_count || 0) +
                        (t.total_consolidations_performed || 0) +
                        (t.donation_count || 0)
                    ),
                    lastUpdate,
                    lastWithdrawalTimestamp: lastWithdrawTs,
                    maxWithdrawLamports: maxLamports,
                    maxWithdrawSol: maxSol,
                };

                displayTreasuryInfo();
                // Update max-withdraw UI and button state
                const maxInfoEl = document.getElementById('withdraw-max-info');
                if (maxInfoEl) {
                    maxInfoEl.textContent = `Maximum available this hour: ${treasuryInfo.maxWithdrawSol.toFixed(2)} SOL`;
                }
                const withdrawBtn = document.getElementById('withdraw-fees-btn');
                if (withdrawBtn) {
                    // Also enforce minimum withdrawal amount and cooldown/penalty via countdown watcher
                    withdrawBtn.disabled = (treasuryInfo.maxWithdrawSol <= 0);
                }
                // Auto-fill input with max when available; clear when zero
                const withdrawInput = document.getElementById('withdrawal-amount');
                if (withdrawInput) {
                    withdrawInput.value = (treasuryInfo.maxWithdrawSol > 0)
                        ? treasuryInfo.maxWithdrawSol.toFixed(2)
                        : '';
                }
                
                // Refresh withdrawal status cache when treasury info is refreshed
                await refreshWithdrawalStatus();
                
                showStatus('success', '‚úÖ Treasury information refreshed');
                
            } catch (error) {
                console.error('‚ùå Failed to refresh treasury info:', error);
                showStatus('error', 'Failed to refresh treasury information: ' + error.message);
            }
        }
        
        /**
         * Display treasury information
         */
        function displayTreasuryInfo() {
            if (!treasuryInfo) return;

            // Populate fields into system-status rows
            const el = document.getElementById('treasury-info-content');
            if (el) {
                const q = (id) => el.querySelector(`#${id}`);
                const safe = (v) => (v ?? '--');
                if (q('treasury-total-balance')) q('treasury-total-balance').textContent = `${treasuryInfo.totalBalance} SOL`;
                if (q('treasury-total-withdrawn')) q('treasury-total-withdrawn').textContent = `${treasuryInfo.totalWithdrawn} SOL`;
                if (q('treasury-total-ops')) q('treasury-total-ops').textContent = safe(treasuryInfo.totalOperations?.toLocaleString());
                
                // Update last withdrawal
                const lastWithdrawalEl = q('last-withdrawal');
                if (lastWithdrawalEl) {
                    if (treasuryInfo.lastWithdrawalTimestamp && treasuryInfo.lastWithdrawalTimestamp > 0) {
                        const lastDt = new Date(treasuryInfo.lastWithdrawalTimestamp * 1000).toLocaleString();
                        lastWithdrawalEl.textContent = lastDt;
                    } else {
                        lastWithdrawalEl.textContent = 'Never';
                    }
                }
            }
        }

        // Calculate current hourly rate limit mirroring on-chain logic
        function calculateCurrentHourlyRateLimit(availableAfterRent) {
            let currentRate = BASE_HOURLY_RATE_LAMPORTS;
            while (availableAfterRent > (MAX_DRAIN_TIME_HOURS * currentRate)) {
                currentRate = currentRate * RATE_SCALING_MULTIPLIER;
                if (!isFinite(currentRate) || currentRate <= 0) break;
            }
            return currentRate;
        }
        
        /**
         * Execute consolidate selected pools
         */
        async function executeConsolidateSelectedPools() {
            try {
                const poolIdsText = document.getElementById('pool-ids').value.trim();
                
                if (!poolIdsText) {
                    showStatus('error', 'Please enter pool IDs to consolidate');
                    return;
                }
                
                const poolIds = poolIdsText.split('\n').map(id => id.trim()).filter(id => id);
                
                if (poolIds.length === 0) {
                    showStatus('error', 'No valid pool IDs found');
                    return;
                }
                
                // Validate all pool IDs
                for (const poolId of poolIds) {
                    if (!window.AdminUtils.validateSolanaAddress(poolId)) {
                        showStatus('error', `Invalid pool ID format: ${poolId}`);
                        return;
                    }
                }
                
                if (!confirm(`Are you sure you want to consolidate fees from ${poolIds.length} pools?\n\nThis will collect fees from each specified pool.`)) {
                    return;
                }
                
                const consolidateBtn = document.getElementById('consolidate-selected-btn');
                consolidateBtn.disabled = true;
                consolidateBtn.textContent = '‚è≥ Consolidating...';
                
                showStatus('info', `üîÑ Consolidating fees from ${poolIds.length} pools...`);
                
                const signatures = [];
                for (const poolId of poolIds) {
                    try {
                        const signature = await window.AdminUtils.executeConsolidatePoolFees(poolId);
                        signatures.push(signature);
                    } catch (error) {
                        console.warn(`Failed to consolidate pool ${poolId}:`, error);
                    }
                }
                
                showStatus('success', `‚úÖ Consolidated fees from ${signatures.length}/${poolIds.length} pools successfully!`);
                
                // Clear form
                document.getElementById('pool-ids').value = '';
                
                // Refresh treasury info
                setTimeout(() => refreshTreasuryInfo(), 2000);
                
            } catch (error) {
                console.error('‚ùå Consolidate selected pools failed:', error);
                showStatus('error', 'Consolidate selected pools failed: ' + error.message);
            } finally {
                const consolidateBtn = document.getElementById('consolidate-selected-btn');
                consolidateBtn.disabled = false;
                consolidateBtn.textContent = 'üîÑ Consolidate Selected Pools';
            }
        }
        
        /**
         * Execute consolidate all pools
         */
        async function executeConsolidateAllPools() {
            try {
                if (!confirm('Are you sure you want to consolidate fees from ALL pools?\n\nThis will automatically discover and consolidate all available pools.')) {
                    return;
                }
                
                const consolidateBtn = document.getElementById('consolidate-all-btn');
                consolidateBtn.disabled = true;
                consolidateBtn.textContent = '‚è≥ Discovering Pools...';
                
                showStatus('info', 'üîç Discovering all pools...');
                
                // Discover all pools
                discoveredPools = await window.AdminUtils.discoverAllPools();
                
                if (discoveredPools.length === 0) {
                    showStatus('warning', 'No pools found to consolidate');
                    return;
                }
                
                consolidateBtn.textContent = `‚è≥ Consolidating ${discoveredPools.length} Pools...`;
                showStatus('info', `üîÑ Consolidating fees from ${discoveredPools.length} discovered pools...`);
                
                const signatures = [];
                for (const pool of discoveredPools) {
                    try {
                        const signature = await window.AdminUtils.executeConsolidatePoolFees(pool.address);
                        signatures.push(signature);
                    } catch (error) {
                        console.warn(`Failed to consolidate pool ${pool.address}:`, error);
                    }
                }
                
                showStatus('success', `‚úÖ Consolidated fees from ${signatures.length}/${discoveredPools.length} pools successfully!`);
                
                // Refresh treasury info
                setTimeout(() => refreshTreasuryInfo(), 2000);
                
            } catch (error) {
                console.error('‚ùå Consolidate all pools failed:', error);
                showStatus('error', 'Consolidate all pools failed: ' + error.message);
            } finally {
                const consolidateBtn = document.getElementById('consolidate-all-btn');
                consolidateBtn.disabled = false;
                consolidateBtn.textContent = 'üîÑ Consolidate All Pools';
            }
        }
        
        /**
         * Execute pause pools
         */
        async function executePausePools() {
            try {
                const poolIdsText = document.getElementById('consolidation-pools').value.trim();
                
                if (!poolIdsText) {
                    showStatus('error', 'Please enter pool IDs to pause');
                    return;
                }
                
                const poolIds = poolIdsText.split('\n').map(id => id.trim()).filter(id => id);
                
                if (poolIds.length === 0) {
                    showStatus('error', 'No valid pool IDs found');
                    return;
                }
                
                if (!confirm(`Are you sure you want to pause ${poolIds.length} pools?\n\nThis will stop all operations for the specified pools.`)) {
                    return;
                }
                
                const pauseBtn = document.getElementById('pause-pools-btn');
                pauseBtn.disabled = true;
                pauseBtn.textContent = '‚è≥ Pausing Pools...';
                
                showStatus('info', `‚è∏Ô∏è Pausing ${poolIds.length} pools...`);
                
                const signatures = [];
                for (const poolId of poolIds) {
                    try {
                        const signature = await window.AdminUtils.executePoolPause(poolId);
                        signatures.push(signature);
                    } catch (error) {
                        console.warn(`Failed to pause pool ${poolId}:`, error);
                    }
                }
                
                showStatus('success', `‚úÖ Paused ${signatures.length}/${poolIds.length} pools successfully!`);
                
            } catch (error) {
                console.error('‚ùå Pause pools failed:', error);
                showStatus('error', 'Pause pools failed: ' + error.message);
            } finally {
                const pauseBtn = document.getElementById('pause-pools-btn');
                pauseBtn.disabled = false;
                pauseBtn.textContent = '‚è∏Ô∏è Pause Pools';
            }
        }
        
        /**
         * Execute unpause pools
         */
        async function executeUnpausePools() {
            try {
                const poolIdsText = document.getElementById('consolidation-pools').value.trim();
                
                if (!poolIdsText) {
                    showStatus('error', 'Please enter pool IDs to unpause');
                    return;
                }
                
                const poolIds = poolIdsText.split('\n').map(id => id.trim()).filter(id => id);
                
                if (poolIds.length === 0) {
                    showStatus('error', 'No valid pool IDs found');
                    return;
                }
                
                if (!confirm(`Are you sure you want to unpause ${poolIds.length} pools?\n\nThis will resume all operations for the specified pools.`)) {
                    return;
                }
                
                const unpauseBtn = document.getElementById('unpause-pools-btn');
                unpauseBtn.disabled = true;
                unpauseBtn.textContent = '‚è≥ Unpausing Pools...';
                
                showStatus('info', `‚ñ∂Ô∏è Unpausing ${poolIds.length} pools...`);
                
                const signatures = [];
                for (const poolId of poolIds) {
                    try {
                        const signature = await window.AdminUtils.executePoolUnpause(poolId);
                        signatures.push(signature);
                    } catch (error) {
                        console.warn(`Failed to unpause pool ${poolId}:`, error);
                    }
                }
                
                showStatus('success', `‚úÖ Unpaused ${signatures.length}/${poolIds.length} pools successfully!`);
                
            } catch (error) {
                console.error('‚ùå Unpause pools failed:', error);
                showStatus('error', 'Unpause pools failed: ' + error.message);
            } finally {
                const unpauseBtn = document.getElementById('unpause-pools-btn');
                unpauseBtn.disabled = false;
                unpauseBtn.textContent = '‚ñ∂Ô∏è Unpause Pools';
            }
        }
        
        /**
         * Execute treasury fee withdrawal
         */
        async function executeTreasuryWithdrawFees() {
            try {
                const amountText = document.getElementById('withdrawal-amount').value.trim();
                const amount = amountText ? parseFloat(amountText) : null;
                
                if (amount !== null && (isNaN(amount) || amount <= 0)) {
                    showStatus('error', 'Invalid withdrawal amount');
                    return;
                }

                // Enforce min and max based on computed caps
                const maxSol = (treasuryInfo?.maxWithdrawSol ?? 0);
                if (maxSol <= 0) {
                    showStatus('error', 'Withdrawal is not available right now due to limits');
                    return;
                }
                if (amount !== null && amount > maxSol) {
                    showStatus('error', `Requested amount exceeds current hourly limit. Max: ${maxSol.toFixed(2)} SOL`);
                    return;
                }
                if ((amount ?? maxSol) < (MIN_WITHDRAW_LAMPORTS / 1_000_000_000)) {
                    showStatus('error', 'Minimum withdrawal is 0.01 SOL');
                    return;
                }
                
                const amountDesc = amount ? `${amount} SOL` : 'maximum available amount';
                
                if (!confirm(`Are you sure you want to withdraw ${amountDesc} from the treasury?\n\nThis operation is subject to dynamic rate limiting.`)) {
                    return;
                }
                
                const withdrawBtn = document.getElementById('withdraw-fees-btn');
                withdrawBtn.disabled = true;
                withdrawBtn.textContent = '‚è≥ Withdrawing...';
                
                showStatus('info', `üí∞ Withdrawing ${amountDesc} from treasury...`);
                
                const signature = await window.AdminUtils.executeTreasuryWithdrawFees(amount);
                
                showStatus('success', `‚úÖ Treasury withdrawal successful! Transaction: ${signature.slice(0, 8)}...`);
                
                // Clear form
                document.getElementById('withdrawal-amount').value = '';
                
                // Refresh treasury info
                setTimeout(() => refreshTreasuryInfo(), 2000);
                
            } catch (error) {
                console.error('‚ùå Treasury withdrawal failed:', error);
                showStatus('error', 'Treasury withdrawal failed: ' + error.message);
            } finally {
                const withdrawBtn = document.getElementById('withdraw-fees-btn');
                withdrawBtn.disabled = false;
                withdrawBtn.textContent = 'üí∞ Withdraw Fees';
            }
        }

        // Simple countdown timer like admin-system.html
        let _withdrawCountdownInterval = null;
        let _cachedWithdrawalStatus = null;
        let _lastStatusCheck = 0;
        
        function startWithdrawalCountdownWatcher() {
            updateWithdrawalCountdown();
            if (_withdrawCountdownInterval !== null) clearInterval(_withdrawCountdownInterval);
            _withdrawCountdownInterval = setInterval(updateWithdrawalCountdown, 1000); // Update every second
        }
        
        async function refreshWithdrawalStatus() {
            // Only refresh cached status, called manually on refresh button
            try {
                _cachedWithdrawalStatus = await window.AdminUtils.getWithdrawalStatus(0.0);
                _lastStatusCheck = Date.now();
            } catch (e) {
                _cachedWithdrawalStatus = null;
            }
        }
        
        function updateWithdrawalCountdown() {
            const countdownEl = document.getElementById('next-withdrawal-countdown');
            const btn = document.getElementById('withdraw-fees-btn');
            
            if (!countdownEl) return;
            
            // Use cached status if available, otherwise fallback to local calculation
            if (_cachedWithdrawalStatus && _cachedWithdrawalStatus.blocked && _cachedWithdrawalStatus.secondsRemaining > 0) {
                // Calculate remaining time based on cached result and elapsed time
                const elapsedSec = Math.floor((Date.now() - _lastStatusCheck) / 1000);
                const remainingSec = Math.max(0, _cachedWithdrawalStatus.secondsRemaining - elapsedSec);
                
                if (remainingSec > 0) {
                    // Format countdown like admin-system.html
                    const days = Math.floor(remainingSec / (24 * 3600));
                    const hours = Math.floor((remainingSec % (24 * 3600)) / 3600);
                    const minutes = Math.floor((remainingSec % 3600) / 60);
                    const seconds = remainingSec % 60;
                    
                    let countdownText = '';
                    if (days > 0) {
                        countdownText = `${days}d ${hours}h ${minutes}m ${seconds}s`;
                    } else if (hours > 0) {
                        countdownText = `${hours}h ${minutes}m ${seconds}s`;
                    } else if (minutes > 0) {
                        countdownText = `${minutes}m ${seconds}s`;
                    } else {
                        countdownText = `${seconds}s`;
                    }
                    
                    countdownEl.textContent = countdownText;
                    countdownEl.className = 'status-value offline'; // Red text for countdown
                    if (btn) btn.disabled = true;
                } else {
                    // Cached countdown expired
                    countdownEl.textContent = '0m 0s';
                    countdownEl.className = 'status-value online'; // Green text when ready
                    const maxOk = (treasuryInfo && treasuryInfo.maxWithdrawSol && treasuryInfo.maxWithdrawSol > 0);
                    if (btn) btn.disabled = !maxOk;
                    _cachedWithdrawalStatus = null; // Clear expired cache
                }
            } else {
                // Fallback: calculate based on local timestamp for 60-minute cooldown
                if (treasuryInfo && treasuryInfo.lastWithdrawalTimestamp && treasuryInfo.lastWithdrawalTimestamp > 0) {
                    const nowSec = Math.floor(Date.now() / 1000);
                    const lastWithdrawalSec = treasuryInfo.lastWithdrawalTimestamp;
                    const nextAllowedSec = lastWithdrawalSec + 3600; // 60 minutes = 3600 seconds
                    const remainingSec = Math.max(0, nextAllowedSec - nowSec);
                    
                    if (remainingSec > 0) {
                        const hours = Math.floor(remainingSec / 3600);
                        const minutes = Math.floor((remainingSec % 3600) / 60);
                        const seconds = remainingSec % 60;
                        
                        let countdownText = '';
                        if (hours > 0) {
                            countdownText = `${hours}h ${minutes}m ${seconds}s`;
                        } else if (minutes > 0) {
                            countdownText = `${minutes}m ${seconds}s`;
                        } else {
                            countdownText = `${seconds}s`;
                        }
                        
                        countdownEl.textContent = countdownText;
                        countdownEl.className = 'status-value offline'; // Red text for countdown
                        if (btn) btn.disabled = true;
                    } else {
                        countdownEl.textContent = '0m 0s';
                        countdownEl.className = 'status-value online'; // Green text when ready
                        const maxOk = (treasuryInfo && treasuryInfo.maxWithdrawSol && treasuryInfo.maxWithdrawSol > 0);
                        if (btn) btn.disabled = !maxOk;
                    }
                } else {
                    // No previous withdrawal
                    countdownEl.textContent = '0m 0s';
                    countdownEl.className = 'status-value online'; // Green text when ready
                    const maxOk = (treasuryInfo && treasuryInfo.maxWithdrawSol && treasuryInfo.maxWithdrawSol > 0);
                    if (btn) btn.disabled = !maxOk;
                }
            }
        }
        
        /**
         * Show status message
         */
        function showStatus(type, message) {
            const container = document.getElementById('status-container');
            const className = type === 'success' ? 'status-message success' : 
                             type === 'info' ? 'status-message info' : 
                             type === 'warning' ? 'status-message warning' : 'status-message error';
            container.innerHTML = `<div class="${className}">${message}</div>`;
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }
        
        // Export functions for global access
        window.refreshTreasuryInfo = refreshTreasuryInfo;
        window.executeConsolidateSelectedPools = executeConsolidateSelectedPools;
        window.executeConsolidateAllPools = executeConsolidateAllPools;
        window.executePausePools = executePausePools;
        window.executeUnpausePools = executeUnpausePools;
        window.executeTreasuryWithdrawFees = executeTreasuryWithdrawFees;
        window.showStatus = showStatus;
    </script>
</body>
</html>
