<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Ratio Trading - Treasury Administration</title>
    <!-- Simple favicon to prevent 404 errors -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 20px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }
        
        .header-title {
            color: #333;
            font-size: 2.5em;
            font-weight: bold;
        }
        
        .header-center {
            text-align: center;
            flex-grow: 1;
        }
        
        .page-title {
            color: #333;
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 1.2em;
        }
        
        .navigation {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .admin-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #f59e0b;
        }
        
        .admin-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .admin-section p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group .help-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .status-message.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .status-message.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        
        .status-message.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        .treasury-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }
        
        .treasury-info h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        
        .info-label {
            font-weight: 500;
            color: #555;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-weight: 600;
            color: #333;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
        }
        
        .footer {
            margin-top: 30px;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            color: #666;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <img src="images/Fixed_Ratio_Trading_Logo.jpeg" alt="Fixed Ratio Trading Logo" class="logo">
                <div class="header-title">Fixed Ratio Trading</div>
            </div>
            <div class="header-center">
                <h1 class="page-title">Treasury Administration</h1>
                <p class="subtitle">Treasury Operations & Fee Management</p>
            </div>
            <div class="navigation">
                <a href="admin.html" class="btn btn-secondary">
                    üîß Admin Dashboard
                </a>
                <a href="index.html" class="btn btn-secondary">
                    üè† Main Dashboard
                </a>
            </div>
        </div>
        
        <div id="status-container"></div>
        
        <!-- Treasury Information Section -->
        <div class="admin-section">
            <h3>üìä Treasury Information</h3>
            <p>Current treasury state and fee collection statistics.</p>
            
            <div id="treasury-info-content" class="treasury-info">
                <div style="text-align: center; color: #666; padding: 20px;">
                    Click "Refresh Treasury Info" to load current treasury data
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="refreshTreasuryInfo()">
                üîÑ Refresh Treasury Info
            </button>
        </div>
        
        <!-- Fee Consolidation Section -->
        <div class="admin-section">
            <h3>üîÑ Fee Consolidation</h3>
            <p>Consolidate fees from individual pools to the main treasury.</p>
            
            <div class="form-group">
                <label for="pool-ids">Pool IDs (One per line)</label>
                <textarea id="pool-ids" rows="5" placeholder="Enter pool state PDA addresses, one per line"></textarea>
                <div class="help-text">Enter pool state PDA addresses to consolidate fees from specific pools</div>
            </div>
            
            <div class="form-row">
                <div>
                    <button id="consolidate-selected-btn" class="btn btn-warning" onclick="executeConsolidateSelectedPools()" style="width: 100%;">
                        üîÑ Consolidate Selected Pools
                    </button>
                    <div class="help-text">Consolidate fees from specified pools</div>
                </div>
                <div>
                    <button id="consolidate-all-btn" class="btn btn-success" onclick="executeConsolidateAllPools()" style="width: 100%;">
                        üîÑ Consolidate All Pools
                    </button>
                    <div class="help-text">Automatically discover and consolidate all pools</div>
                </div>
            </div>
        </div>
        
        <!-- Pool State Management Section -->
        <div class="admin-section">
            <h3>‚è∏Ô∏è Pool State Management</h3>
            <p>Manage pool pause states before and after consolidation operations.</p>
            
            <div class="form-group">
                <label for="consolidation-pools">Pools for State Management</label>
                <textarea id="consolidation-pools" rows="3" placeholder="Enter pool state PDA addresses for pause/unpause operations"></textarea>
                <div class="help-text">Enter pool addresses to manage their pause states</div>
            </div>
            
            <div class="form-row">
                <div>
                    <button id="pause-pools-btn" class="btn btn-warning" onclick="executePausePools()" style="width: 100%;">
                        ‚è∏Ô∏è Pause Pools
                    </button>
                    <div class="help-text">Pause specified pools before consolidation</div>
                </div>
                <div>
                    <button id="unpause-pools-btn" class="btn btn-success" onclick="executeUnpausePools()" style="width: 100%;">
                        ‚ñ∂Ô∏è Unpause Pools
                    </button>
                    <div class="help-text">Resume specified pools after consolidation</div>
                </div>
            </div>
        </div>
        
        <!-- Fee Withdrawal Section -->
        <div class="admin-section">
            <h3>üí∞ Fee Withdrawal</h3>
            <p>Withdraw collected fees from the treasury (subject to dynamic rate limiting).</p>
            
            <div class="form-group">
                <label for="withdrawal-amount">Withdrawal Amount (SOL)</label>
                <input type="number" id="withdrawal-amount" step="0.001" placeholder="Leave empty for maximum amount">
                <div class="help-text">Enter amount in SOL, or leave empty to withdraw maximum available amount</div>
            </div>
            
            <button id="withdraw-fees-btn" class="btn btn-primary" onclick="executeTreasuryWithdrawFees()">
                üí∞ Withdraw Fees
            </button>
            <div id="withdrawal-countdown" class="help-text" style="margin-top:8px; display:none;">
                ‚è±Ô∏è Next withdrawal available in: <span id="withdrawal-countdown-value">--:--</span>
            </div>
        </div>
        
        <div class="footer">
            <p>Fixed Ratio Trading Treasury Administration | Local Solana Testnet</p>
            <p style="color: #6b7280; font-size: 12px; margin-top: 10px;">
                ‚ö†Ô∏è Treasury operations require admin authority and affect fee collection
            </p>
        </div>
    </div>

    <script src="libs/solana-web3.min.js"></script>
    <script src="config.js"></script>
    <script src="data-service.js"></script>
    <script src="utils.js"></script>
    <script src="admin-utils.js"></script>
    <script>
        // Global state
        let treasuryInfo = null;
        let discoveredPools = [];
        
        // Initialize treasury admin page
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üí∞ Treasury Administration page initializing...');
            await initializeTreasuryAdmin();
        });
        
        /**
         * Initialize treasury administration page
         */
        async function initializeTreasuryAdmin() {
            try {
                // Initialize admin utilities
                await window.AdminUtils.initializeAdminUtils();
                
                // Check wallet connection
                const isConnected = sessionStorage.getItem('adminWalletConnected') === 'true';
                const walletProvider = sessionStorage.getItem('adminWalletProvider');
                if (!isConnected) {
                    showStatus('warning', '‚ö†Ô∏è Wallet not connected. Please connect your wallet first.');
                    return;
                }
                
                console.log(`‚úÖ Using ${walletProvider || 'Unknown'} wallet for treasury administration`);
                
                // Auto-refresh treasury info if wallet is connected
                await refreshTreasuryInfo();
                // Start withdrawal countdown watcher
                startWithdrawalCountdownWatcher();
                
                console.log('‚úÖ Treasury administration page initialized');
            } catch (error) {
                console.error('‚ùå Failed to initialize treasury admin:', error);
                showStatus('error', 'Failed to initialize treasury administration: ' + error.message);
            }
        }
        
        /**
         * Refresh treasury information
         */
        async function refreshTreasuryInfo() {
            try {
                showStatus('info', 'üîÑ Refreshing treasury information...');
                // Load real-time treasury info via centralized data service
                if (!window.TradingDataService?.connection) {
                    // Ensure a connection exists if admin utils connection is not ready
                    const conn = window.AdminUtils?.adminConnection || new solanaWeb3.Connection(window.CONFIG.rpcUrl, { commitment: 'confirmed' });
                    await window.TradingDataService.initialize(window.CONFIG, conn);
                }
                const state = await window.TradingDataService.loadStateJsonExact();
                const t = state.main_treasury_state;
                if (!t) throw new Error('Treasury state not found');

                const totalBalanceSol = (t.total_balance / 1_000_000_000).toFixed(9).replace(/0+$/,'').replace(/\.$/,'');
                const totalWithdrawnSol = (t.total_withdrawn / 1_000_000_000).toFixed(9).replace(/0+$/,'').replace(/\.$/,'');
                const lastUpdate = t.last_update_timestamp ? new Date(t.last_update_timestamp * 1000).toLocaleString() : 'N/A';
                const lastWithdrawTs = (t.last_withdrawal_timestamp ?? 0);

                treasuryInfo = {
                    totalBalance: totalBalanceSol,
                    totalWithdrawn: totalWithdrawnSol,
                    totalOperations: (t.pool_creation_count + t.liquidity_operation_count + t.regular_swap_count + t.treasury_withdrawal_count),
                    lastUpdate,
                    lastWithdrawalTimestamp: lastWithdrawTs,
                };

                displayTreasuryInfo();
                showStatus('success', '‚úÖ Treasury information refreshed');
                
            } catch (error) {
                console.error('‚ùå Failed to refresh treasury info:', error);
                showStatus('error', 'Failed to refresh treasury information: ' + error.message);
            }
        }
        
        /**
         * Display treasury information
         */
        function displayTreasuryInfo() {
            if (!treasuryInfo) return;

            // Withdraw status: show last withdrawal timestamp and 60-minute countdown if within window
            let withdrawStatus = '‚úÖ Available';
            if (typeof treasuryInfo.lastWithdrawalTimestamp === 'number' && treasuryInfo.lastWithdrawalTimestamp > 0) {
                const lastDt = new Date(treasuryInfo.lastWithdrawalTimestamp * 1000).toLocaleString();
                const nowSec = Math.floor(Date.now() / 1000);
                const since = nowSec - treasuryInfo.lastWithdrawalTimestamp;
                if (since < 3600) {
                    const remaining = 3600 - since;
                    const m = Math.floor(remaining / 60);
                    const s = remaining % 60;
                    withdrawStatus = `Last: ${lastDt} ‚Ä¢ ‚è≥ Next in ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                } else {
                    withdrawStatus = `Last: ${lastDt} ‚Ä¢ ‚úÖ Available`;
                }
            }

            const content = `
                <h4>Treasury Status</h4>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Total Balance</div>
                        <div class="info-value">${treasuryInfo.totalBalance} SOL</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Total Withdrawn</div>
                        <div class="info-value">${treasuryInfo.totalWithdrawn} SOL</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Total Operations</div>
                        <div class="info-value">${treasuryInfo.totalOperations.toLocaleString()}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Last Updated</div>
                        <div class="info-value">${treasuryInfo.lastUpdate}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Withdraw Status</div>
                        <div class="info-value">${withdrawStatus}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('treasury-info-content').innerHTML = content;
        }
        
        /**
         * Execute consolidate selected pools
         */
        async function executeConsolidateSelectedPools() {
            try {
                const poolIdsText = document.getElementById('pool-ids').value.trim();
                
                if (!poolIdsText) {
                    showStatus('error', 'Please enter pool IDs to consolidate');
                    return;
                }
                
                const poolIds = poolIdsText.split('\n').map(id => id.trim()).filter(id => id);
                
                if (poolIds.length === 0) {
                    showStatus('error', 'No valid pool IDs found');
                    return;
                }
                
                // Validate all pool IDs
                for (const poolId of poolIds) {
                    if (!window.AdminUtils.validateSolanaAddress(poolId)) {
                        showStatus('error', `Invalid pool ID format: ${poolId}`);
                        return;
                    }
                }
                
                if (!confirm(`Are you sure you want to consolidate fees from ${poolIds.length} pools?\n\nThis will collect fees from each specified pool.`)) {
                    return;
                }
                
                const consolidateBtn = document.getElementById('consolidate-selected-btn');
                consolidateBtn.disabled = true;
                consolidateBtn.textContent = '‚è≥ Consolidating...';
                
                showStatus('info', `üîÑ Consolidating fees from ${poolIds.length} pools...`);
                
                const signatures = [];
                for (const poolId of poolIds) {
                    try {
                        const signature = await window.AdminUtils.executeConsolidatePoolFees(poolId);
                        signatures.push(signature);
                    } catch (error) {
                        console.warn(`Failed to consolidate pool ${poolId}:`, error);
                    }
                }
                
                showStatus('success', `‚úÖ Consolidated fees from ${signatures.length}/${poolIds.length} pools successfully!`);
                
                // Clear form
                document.getElementById('pool-ids').value = '';
                
                // Refresh treasury info
                setTimeout(() => refreshTreasuryInfo(), 2000);
                
            } catch (error) {
                console.error('‚ùå Consolidate selected pools failed:', error);
                showStatus('error', 'Consolidate selected pools failed: ' + error.message);
            } finally {
                const consolidateBtn = document.getElementById('consolidate-selected-btn');
                consolidateBtn.disabled = false;
                consolidateBtn.textContent = 'üîÑ Consolidate Selected Pools';
            }
        }
        
        /**
         * Execute consolidate all pools
         */
        async function executeConsolidateAllPools() {
            try {
                if (!confirm('Are you sure you want to consolidate fees from ALL pools?\n\nThis will automatically discover and consolidate all available pools.')) {
                    return;
                }
                
                const consolidateBtn = document.getElementById('consolidate-all-btn');
                consolidateBtn.disabled = true;
                consolidateBtn.textContent = '‚è≥ Discovering Pools...';
                
                showStatus('info', 'üîç Discovering all pools...');
                
                // Discover all pools
                discoveredPools = await window.AdminUtils.discoverAllPools();
                
                if (discoveredPools.length === 0) {
                    showStatus('warning', 'No pools found to consolidate');
                    return;
                }
                
                consolidateBtn.textContent = `‚è≥ Consolidating ${discoveredPools.length} Pools...`;
                showStatus('info', `üîÑ Consolidating fees from ${discoveredPools.length} discovered pools...`);
                
                const signatures = [];
                for (const pool of discoveredPools) {
                    try {
                        const signature = await window.AdminUtils.executeConsolidatePoolFees(pool.address);
                        signatures.push(signature);
                    } catch (error) {
                        console.warn(`Failed to consolidate pool ${pool.address}:`, error);
                    }
                }
                
                showStatus('success', `‚úÖ Consolidated fees from ${signatures.length}/${discoveredPools.length} pools successfully!`);
                
                // Refresh treasury info
                setTimeout(() => refreshTreasuryInfo(), 2000);
                
            } catch (error) {
                console.error('‚ùå Consolidate all pools failed:', error);
                showStatus('error', 'Consolidate all pools failed: ' + error.message);
            } finally {
                const consolidateBtn = document.getElementById('consolidate-all-btn');
                consolidateBtn.disabled = false;
                consolidateBtn.textContent = 'üîÑ Consolidate All Pools';
            }
        }
        
        /**
         * Execute pause pools
         */
        async function executePausePools() {
            try {
                const poolIdsText = document.getElementById('consolidation-pools').value.trim();
                
                if (!poolIdsText) {
                    showStatus('error', 'Please enter pool IDs to pause');
                    return;
                }
                
                const poolIds = poolIdsText.split('\n').map(id => id.trim()).filter(id => id);
                
                if (poolIds.length === 0) {
                    showStatus('error', 'No valid pool IDs found');
                    return;
                }
                
                if (!confirm(`Are you sure you want to pause ${poolIds.length} pools?\n\nThis will stop all operations for the specified pools.`)) {
                    return;
                }
                
                const pauseBtn = document.getElementById('pause-pools-btn');
                pauseBtn.disabled = true;
                pauseBtn.textContent = '‚è≥ Pausing Pools...';
                
                showStatus('info', `‚è∏Ô∏è Pausing ${poolIds.length} pools...`);
                
                const signatures = [];
                for (const poolId of poolIds) {
                    try {
                        const signature = await window.AdminUtils.executePoolPause(poolId);
                        signatures.push(signature);
                    } catch (error) {
                        console.warn(`Failed to pause pool ${poolId}:`, error);
                    }
                }
                
                showStatus('success', `‚úÖ Paused ${signatures.length}/${poolIds.length} pools successfully!`);
                
            } catch (error) {
                console.error('‚ùå Pause pools failed:', error);
                showStatus('error', 'Pause pools failed: ' + error.message);
            } finally {
                const pauseBtn = document.getElementById('pause-pools-btn');
                pauseBtn.disabled = false;
                pauseBtn.textContent = '‚è∏Ô∏è Pause Pools';
            }
        }
        
        /**
         * Execute unpause pools
         */
        async function executeUnpausePools() {
            try {
                const poolIdsText = document.getElementById('consolidation-pools').value.trim();
                
                if (!poolIdsText) {
                    showStatus('error', 'Please enter pool IDs to unpause');
                    return;
                }
                
                const poolIds = poolIdsText.split('\n').map(id => id.trim()).filter(id => id);
                
                if (poolIds.length === 0) {
                    showStatus('error', 'No valid pool IDs found');
                    return;
                }
                
                if (!confirm(`Are you sure you want to unpause ${poolIds.length} pools?\n\nThis will resume all operations for the specified pools.`)) {
                    return;
                }
                
                const unpauseBtn = document.getElementById('unpause-pools-btn');
                unpauseBtn.disabled = true;
                unpauseBtn.textContent = '‚è≥ Unpausing Pools...';
                
                showStatus('info', `‚ñ∂Ô∏è Unpausing ${poolIds.length} pools...`);
                
                const signatures = [];
                for (const poolId of poolIds) {
                    try {
                        const signature = await window.AdminUtils.executePoolUnpause(poolId);
                        signatures.push(signature);
                    } catch (error) {
                        console.warn(`Failed to unpause pool ${poolId}:`, error);
                    }
                }
                
                showStatus('success', `‚úÖ Unpaused ${signatures.length}/${poolIds.length} pools successfully!`);
                
            } catch (error) {
                console.error('‚ùå Unpause pools failed:', error);
                showStatus('error', 'Unpause pools failed: ' + error.message);
            } finally {
                const unpauseBtn = document.getElementById('unpause-pools-btn');
                unpauseBtn.disabled = false;
                unpauseBtn.textContent = '‚ñ∂Ô∏è Unpause Pools';
            }
        }
        
        /**
         * Execute treasury fee withdrawal
         */
        async function executeTreasuryWithdrawFees() {
            try {
                const amountText = document.getElementById('withdrawal-amount').value.trim();
                const amount = amountText ? parseFloat(amountText) : null;
                
                if (amount !== null && (isNaN(amount) || amount <= 0)) {
                    showStatus('error', 'Invalid withdrawal amount');
                    return;
                }
                
                const amountDesc = amount ? `${amount} SOL` : 'maximum available amount';
                
                if (!confirm(`Are you sure you want to withdraw ${amountDesc} from the treasury?\n\nThis operation is subject to dynamic rate limiting.`)) {
                    return;
                }
                
                const withdrawBtn = document.getElementById('withdraw-fees-btn');
                withdrawBtn.disabled = true;
                withdrawBtn.textContent = '‚è≥ Withdrawing...';
                
                showStatus('info', `üí∞ Withdrawing ${amountDesc} from treasury...`);
                
                const signature = await window.AdminUtils.executeTreasuryWithdrawFees(amount);
                
                showStatus('success', `‚úÖ Treasury withdrawal successful! Transaction: ${signature.slice(0, 8)}...`);
                
                // Clear form
                document.getElementById('withdrawal-amount').value = '';
                
                // Refresh treasury info
                setTimeout(() => refreshTreasuryInfo(), 2000);
                
            } catch (error) {
                console.error('‚ùå Treasury withdrawal failed:', error);
                showStatus('error', 'Treasury withdrawal failed: ' + error.message);
            } finally {
                const withdrawBtn = document.getElementById('withdraw-fees-btn');
                withdrawBtn.disabled = false;
                withdrawBtn.textContent = 'üí∞ Withdraw Fees';
            }
        }

        // Countdown logic: poll withdrawal status and render countdown
        let _withdrawCountdownInterval = null;
        async function startWithdrawalCountdownWatcher() {
            try {
                await updateWithdrawalCountdown();
                if (_withdrawCountdownInterval !== null) clearInterval(_withdrawCountdownInterval);
                _withdrawCountdownInterval = setInterval(updateWithdrawalCountdown, 15_000); // every 15s
            } catch (_) {}
        }
        async function updateWithdrawalCountdown() {
            try {
                const status = await window.AdminUtils.getWithdrawalStatus(0.0);
                const el = document.getElementById('withdrawal-countdown');
                const val = document.getElementById('withdrawal-countdown-value');
                const btn = document.getElementById('withdraw-fees-btn');
                if (status && status.blocked) {
                    const secs = status.secondsRemaining ?? 0;
                    const m = Math.floor(secs / 60);
                    const s = secs % 60;
                    val.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                    el.style.display = '';
                    btn.disabled = true;
                } else {
                    el.style.display = 'none';
                    val.textContent = '';
                    btn.disabled = false;
                }
            } catch (_) {}
        }
        
        /**
         * Show status message
         */
        function showStatus(type, message) {
            const container = document.getElementById('status-container');
            const className = type === 'success' ? 'status-message success' : 
                             type === 'info' ? 'status-message info' : 
                             type === 'warning' ? 'status-message warning' : 'status-message error';
            container.innerHTML = `<div class="${className}">${message}</div>`;
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }
        
        // Export functions for global access
        window.refreshTreasuryInfo = refreshTreasuryInfo;
        window.executeConsolidateSelectedPools = executeConsolidateSelectedPools;
        window.executeConsolidateAllPools = executeConsolidateAllPools;
        window.executePausePools = executePausePools;
        window.executeUnpausePools = executeUnpausePools;
        window.executeTreasuryWithdrawFees = executeTreasuryWithdrawFees;
        window.showStatus = showStatus;
    </script>
</body>
</html>
